# OS Study Notes
> Orange's 一个操作系统的实现 阅读笔记

### NASM
什么是NASM?  
NASM是一个为可移植性与模块化而设计的一个80x86的汇编器。它支持相当多
的目标文件格式，包括Linux和'NetBSD/FreeBSD','a.out','ELF','COFF',微软16
位的'OBJ'和'Win32'。它还可以输出纯二进制文件。它的语法设计得相当的简
洁易懂，和Intel语法相似但更简单。它支持'Pentium','P6','MMX','3DNow!',
'SSE' and 'SSE2'指令集.   
  
在NASM中, 任何不被方括号[]括起来的标签或者变量名都被认为是地址, 访问标签中的内容必须使用[].所以:  
```Assembly
mov ax, BootMessage
BootMessage:    db  "Hello, OS World!"
```  
将会把这个字符串的首地址送到ax中. 如果有
```Assembly
foo     dw      1
mov     ax, foo;    将把foo的地址放入ax中
mov     bx, [foo];  将把foo的值(1)放入bx中
```

`offset`这个关键字在NASM中也是不需要的, 因为不加`[]`时就表示offset.

### 汇编指令
* ORG是Origin的缩写：起始地址，源。在汇编语言源程序的开始通常都用一条ORG伪指令来实现规定程序的起始地址。如果不用ORG规定则汇编得到的目标程序将从0000H开始。例如：
```Assembly
 　　      ORG 2000H 　　
    START：MOV  AX，#00H
```
汇编语言源程序中若没有ORG伪指令，则程序执行时，指令代码被放到自由内存空间的CS:0处；若有ORG伪指令，编译器则把其后的指令代码放到ORG伪指令指定的偏移地址。两个ORG伪指令之间，除了指令代码，若有自由空间，则用0填充。

* JMP $  
$，代表当前地址。
$ 放在 LJMP 之后，它就代表这条指令本身的地址。
JMP $，就是转移到该指令的本身地址。
JMP $，就是原地转移的意思，即 死循环。
一旦有中断发生，就可以去执行中断程序。
注: 而`$$`表示一个节(section)的开始处被汇编的地址. 在写程序的过程中, `$-$$`会经常用到.表示`本行距离程序开始处的相对距离`.  
`times   510-($-$$)  db  0;`表示将0这个字节重复`510-($-$$)`遍也就是剩下的空间都填充0直到510. 

### 引导扇区
当计算机电源被打开, 会先进行加电自检(POST), 然后寻找启动盘, 如果是选择从软盘启动, 计算机就会去检查软盘的`0面0磁道1扇区`, 如果它以`0xAA55`结束, 则BIOS认为它是一个引导扇区. 一个正确的引导扇区除了以0xaa55结束以外, 还应该包含一段少于512个字节的执行码. 接下来, 一旦BIOS发现了引导扇区, 就会将这512个字节的内容装载到内存地址`0000:7c00`处, 然后跳转到`0000:7c00`彻底将控制权交给这段代码. 到此为止, 计算机不再由BIOS控制, 而变成操作系统的一部分来控制.


### 调试
在Windows下, 可以选择的调试方法包括把引导扇区的代码的`ORG 07c00h`改为`ORG 0100h`就可以编译成一个.COM文件在DOS下运行了. 
调试环境: Bochs  
Bochs（发音：box）是一个以GNU宽通用公共许可证发放的开放源代码的x86、x86-64IBM PC兼容机模拟器和调试工具。它支持处理器（包括保护模式），内存，硬盘，显示器，以太网，BIOS，IBM PC兼容机的常见硬件外设的仿真。    
许多客户操作系统能通过该仿真器运行，包括DOS，Microsoft Windows的一些版本, AmigaOS 4, BSD, Linux, MorphOS, Xenix和Rhapsody (Mac OS X的前身).  Bochs能在许多主机操作系统运行，例如Windows, Windows Mobile, Linux, Mac OS X, iOS, PlayStation 2.  
Bochs主要用于操作系统开发（当一个模拟操作系统崩溃，它不崩溃主机操作系统，所以可以调试仿真操作系统）和在主机操作系统运行其他来宾操作系统。它也可以用来运行不兼容的旧的软件（如电脑游戏）。  
它的优点在于能够模拟跟主机不同的机种，例如在Sparc系统里模拟x86，但缺点是它的速度却慢得多。

`bximage`: 生成虚拟软盘(floppy disk)或虚拟硬盘(hard disk)    
`dd if=boot.bin of=a.img bs=512 count=1 conv=nontrunc   ; 将引导扇区写进软盘`  
最后一个参数表示不裁剪,不截断(truncated). 使用真实软盘装载时不需要此参数, 因为真的不会被截断.
然后再`a.img`所在目录下新建`bochsrc`配置文件, 然后在终端输入`bochs`即可运行. 如果运行黑屏则是调试模式, 终端输入`c`解决.



### souce命令
source命令也称为“点命令”，也就是一个点符号（.）。source命令通常用于重新执行刚修改的初始化文件，使之立即生效，而不必注销并重新登录。










